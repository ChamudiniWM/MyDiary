<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDiary</title>
    <script src="https://cdn.tailwindcss.com?noProdCheck=1"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.6/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
        const [entries, setEntries] = useState([]);
        const [content, setContent] = useState('');
        const [image, setImage] = useState(null);
        const [video, setVideo] = useState(null);
        const [audio, setAudio] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => {
            fetchEntries();
        }, []);

        const fetchEntries = async () => {
            setLoading(true);
            setError(null);
            try {
                const response = await axios.get('http://localhost:8080/api/diary', {
                    headers: { 'Accept': 'application/json' }
                });
                console.log('Fetched entries response:', response); // Log full response
                setEntries(response.data);
            } catch (error) {
                console.error('Error fetching entries:', {
                    message: error.message,
                    status: error.response?.status,
                    data: error.response?.data
                });
                setError(`Failed to load entries. Status: ${error.response?.status || 'Unknown'}, Message: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!content.trim()) {
                setError('Content is required');
                return;
            }
            setLoading(true);
            setError(null);
            const formData = new FormData();
            formData.append('content', content);
            if (image) formData.append('image', image);
            if (video) formData.append('video', video);
            if (audio) formData.append('audio', audio);
            console.log('Sending data:', { content, image: image?.name, video: video?.name, audio: audio?.name });

            try {
                const response = await axios.post('http://localhost:8080/api/diary', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                console.log('Post response:', response.data);
                setContent('');
                setImage(null);
                setVideo(null);
                setAudio(null);
                await fetchEntries(); // Refresh entries
                console.log('Entry saved and refreshed');
            } catch (error) {
                console.error('Error creating entry:', {
                    message: error.message,
                    status: error.response?.status,
                    data: error.response?.data
                });
                setError(`Failed to save entry. Status: ${error.response?.status || 'Unknown'}, Message: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="container mx-auto p-4">
                <h1 className="text-3xl font-bold mb-4">MyDiary</h1>
                <div className="mb-8">
                    <h2 className="text-xl font-semibold mb-2">New Entry</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <textarea
                            className="w-full p-2 border rounded"
                            rows="4"
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            placeholder="Write your diary entry..."
                            required
                        />
                        <div>
                            <label className="block mb-1">Image:</label>
                            <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => setImage(e.target.files ? e.target.files[0] : null)}
                                className="p-2"
                            />
                        </div>
                        <div>
                            <label className="block mb-1">Video:</label>
                            <input
                                type="file"
                                accept="video/*"
                                onChange={(e) => setVideo(e.target.files ? e.target.files[0] : null)}
                                className="p-2"
                            />
                        </div>
                        <div>
                            <label className="block mb-1">Audio:</label>
                            <input
                                type="file"
                                accept="audio/*"
                                onChange={(e) => setAudio(e.target.files ? e.target.files[0] : null)}
                                className="p-2"
                            />
                        </div>
                        <button
                            type="submit"
                            className={`bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                            disabled={loading}
                        >
                            {loading ? 'Saving...' : 'Save Entry'}
                        </button>
                        {error && <p className="text-red-500 mt-2">{error}</p>}
                    </form>
                </div>
                <h2 className="text-xl font-semibold mb-2">Diary Entries</h2>
                <div className="space-y-4">
                    {loading ? (
                        <p>Loading...</p>
                    ) : entries.length === 0 ? (
                        <p>No entries yet.</p>
                    ) : (
                        entries.map(entry => (
                            <div key={entry.id} className="border p-4 rounded">
                                <p className="text-gray-600 text-sm">{new Date(entry.createdAt).toLocaleString()}</p>
                                <p className="mt-2">{entry.content}</p>
                                {entry.imagePath && (
                                    <img src={`http://localhost:8080/api/diary/media/${entry.imagePath}`} alt="Diary Image" className="mt-2 max-w-xs" />
                                )}
                                {entry.videoPath && (
                                    <video controls className="mt-2 max-w-xs">
                                        <source src={`http://localhost:8080/api/diary/media/${entry.videoPath}`} />
                                    </video>
                                )}
                                {entry.audioPath && (
                                    <audio controls className="mt-2">
                                        <source src={`http://localhost:8080/api/diary/media/${entry.audioPath}`} />
                                    </audio>
                                )}
                            </div>
                        ))
                    )}
                </div>
            </div>
        );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>